# 1. Má»¥c tiÃªu

Gemini CLI cáº§n thá»±c hiá»‡n:

ğŸ‘‰ Nháº­n **HTML gia pháº£ (raw)**
ğŸ‘‰ DÃ¹ng **Python + BeautifulSoup** Ä‘á»ƒ parse
ğŸ‘‰ TrÃ­ch xuáº¥t dá»¯ liá»‡u **theo text label tiáº¿ng Viá»‡t**
ğŸ‘‰ Xuáº¥t ra **JSON Ä‘Ãºng schema**

---

# 2. YÃªu cáº§u ká»¹ thuáº­t

* Python â‰¥ 3.9
* ThÆ° viá»‡n:

```bash
pip install beautifulsoup4 lxml
```

---

# 3. NguyÃªn táº¯c báº¯t buá»™c (Gemini pháº£i tuÃ¢n theo)

1. âŒ **KHÃ”NG dá»±a vÃ o class / id HTML**
2. âœ… **CHá»ˆ dá»±a vÃ o ná»™i dung text tiáº¿ng Viá»‡t**
3. âœ… **Duyá»‡t `<tr>` theo thá»© tá»± xuáº¥t hiá»‡n**
4. âœ… **DÃ¹ng state machine (section-based parsing)**
5. âœ… **Output luÃ´n Ä‘Ãºng schema, Ä‘á»§ field (ká»ƒ cáº£ null / empty)**

---

# 4. Schema output chuáº©n (báº¯t buá»™c)

```python
OUTPUT_SCHEMA = {
    "lastName": "",
    "firstName": "",
    "code": "",
    "nickname": "",
    "dateOfBirth": None,
    "dateOfDeath": None,
    "dateOfDeathLunar": None,
    "placeOfBirth": None,
    "placeOfDeath": None,
    "phone": "",
    "email": "",
    "address": "",
    "gender": "",
    "avatarUrl": "",
    "avatarBase64": "",
    "occupation": "",
    "biography": "",
    "isRoot": False,
    "isDeceased": False,
    "order": 0,
    "generation": 0,
    "father": None,
    "mother": None,
    "spouses": []
}
```

---

# 5. Chiáº¿n lÆ°á»£c xá»­ lÃ½ HTML

## 5.1 Parse DOM

```python
soup = BeautifulSoup(html, "lxml")
rows = soup.find_all("tr")
```

---

## 5.2 Khai bÃ¡o state (ráº¥t quan trá»ng)

```python
current_section = None
current_spouse = None
```

Section cÃ³ thá»ƒ lÃ :

```python
FAMILY
PERSON
SPOUSE
CHILDREN
```

---

# 6. Nháº­n diá»‡n section báº±ng TEXT

Gemini CLI pháº£i dÃ² **text trong `<tr>`**

```python
row_text = row.get_text(strip=True)
```

| Text chá»©a             | Section  |
| --------------------- | -------- |
| Chi tiáº¿t gia Ä‘Ã¬nh     | FAMILY   |
| NgÆ°á»i trong gia Ä‘Ã¬nh  | PERSON   |
| LiÃªn quan (chá»“ng, vá»£) | SPOUSE   |
| Con cÃ¡i               | CHILDREN |

---

# 7. Mapping chi tiáº¿t tá»«ng field

## 7.1 Há» â€“ tÃªn â€“ giá»›i tÃ­nh

HTML:

```
TÃªn | Cao Triáº¿t (Nam)
```

### Quy táº¯c:

* Text trong `()` â†’ gender
* Pháº§n cÃ²n láº¡i â†’ full name
* Tá»« Ä‘áº§u tiÃªn â†’ lastName
* Pháº§n cÃ²n láº¡i â†’ firstName

```python
def parse_name_gender(text):
    gender = extract_between_parentheses(text)
    name = remove_parentheses(text)
    parts = name.split()
    return {
        "lastName": parts[0],
        "firstName": " ".join(parts[1:]),
        "gender": gender
    }
```

---

## 7.2 Nickname

```
TÃªn thÆ°á»ng | LÃ½ Triáº¿t
```

```python
output["nickname"] = value
```

---

## 7.3 Generation (Äá»i thá»©)

```
Äá»i thá»©: 0
```

```python
output["generation"] = int(value)
```

---

## 7.4 Order (LÃ  con thá»©)

```python
output["order"] = int(value)
```

---

## 7.5 NgÃ y sinh / ngÃ y máº¥t

```python
if label == "NgÃ y sinh":
    output["dateOfBirth"] = normalize_date(value)

if label == "NgÃ y máº¥t":
    output["dateOfDeath"] = normalize_date(value)
    output["isDeceased"] = True
```

---

## 7.6 HÆ°á»Ÿng thá» â†’ isDeceased

```python
if label == "HÆ°á»Ÿng thá»":
    output["isDeceased"] = True
```

---

## 7.7 NÆ¡i an tÃ¡ng â†’ placeOfDeath

```python
if label == "NÆ¡i an tÃ¡ng":
    output["placeOfDeath"] = value
```

---

## 7.8 Biography (ghi chÃº dÃ i)

Pattern:

```
Sá»± nghiá»‡p, cÃ´ng Ä‘á»©c, ghi chÃº
<tr><td>TEXT DÃ€I</td></tr>
```

```python
if label == "Sá»± nghiá»‡p, cÃ´ng Ä‘á»©c, ghi chÃº":
    next_row = rows[i + 1]
    output["biography"] = clean_text(next_row.get_text())
```

---

## 7.9 Father

HTML:

```
LÃ  con cá»§a: Thuá»· tá»•
```

```python
output["father"] = {
    "lastName": extract_last_name(value),
    "firstName": extract_first_name(value),
    "code": None,
    "gender": "Nam"
}
```

```python
output["isRoot"] = False
```

Náº¿u khÃ´ng cÃ³ dÃ²ng nÃ y:

```python
output["isRoot"] = True
```

---

## 7.10 Spouses (vá»£ / chá»“ng)

### Khi gáº·p:

```
LiÃªn quan (chá»“ng, vá»£)
```

Táº¡o object spouse má»›i khi gáº·p `"TÃªn"`

```python
current_spouse = {
    "lastName": "",
    "firstName": "",
    "gender": "",
    "dateOfBirth": None,
    "dateOfDeath": None,
    "biography": ""
}
```

Mapping giá»‘ng PERSON nhÆ°ng Ä‘Æ¡n giáº£n hÆ¡n.

Khi gáº·p spouse má»›i â†’ push spouse cÅ© vÃ o `output["spouses"]`.

---

# 8. Chuáº©n hoÃ¡ dá»¯ liá»‡u (báº¯t buá»™c)

Gemini CLI pháº£i:

* Trim string
* `""` cho text rá»—ng
* `None` cho date khÃ´ng cÃ³
* Remove `&nbsp;`, tag XML láº¡
* KhÃ´ng bá» field nÃ o trong schema

---

# 9. Sinh code (náº¿u cáº§n)

```python
output["code"] = generate_member_code(
    lastName=output["lastName"],
    gender=output["gender"],
    generation=output["generation"],
    order=output["order"]
)
```

---

# 10. Output cuá»‘i cÃ¹ng

```python
return json.dumps(output, ensure_ascii=False, indent=2)
```

---

# 11. Checklist Ä‘á»ƒ Gemini CLI tá»± kiá»ƒm tra

â˜‘ CÃ³ Ä‘á»§ field schema
â˜‘ KhÃ´ng crash náº¿u thiáº¿u dá»¯ liá»‡u
â˜‘ Cháº¡y Ä‘Æ°á»£c vá»›i nhiá»u page cÃ¹ng format
â˜‘ KhÃ´ng hardcode index HTML

---


Bá»” SUNG PHáº¦N TRÃCH XUáº¤T
CÃ¡c anh em, dÃ¢u rá»ƒ & Con cÃ¡i
1. NguyÃªn táº¯c chung (Gemini CLI pháº£i tuÃ¢n theo)

Dá»¯ liá»‡u anh em / con cÃ¡i thÆ°á»ng náº±m trong cÃ¹ng 1 <td>

DÃ¹ng:

<br> Ä‘á»ƒ tÃ¡ch tÃªn

Text Ä‘á»©ng sau dáº¥u : lÃ  dá»¯ liá»‡u

KHÃ”NG táº¡o member Ä‘áº§y Ä‘á»§ ngay

Chá»‰ táº¡o stub object (Ä‘á»§ Ä‘á»ƒ liÃªn káº¿t graph)

KhÃ´ng nháº§m anh em vá»›i con cÃ¡i

2. Cáº­p nháº­t schema má»Ÿ rá»™ng (khuyáº¿n nghá»‹)

ğŸ‘‰ KHÃ”NG sá»­a schema gá»‘c, chá»‰ append field má»›i

# má»Ÿ rá»™ng output
output["siblings"] = []   # anh chá»‹ em ruá»™t
output["children"] = []   # con ruá»™t

Stub object chuáº©n
{
  "lastName": "",
  "firstName": "",
  "gender": "",
  "code": None
}

3. Nháº­n diá»‡n block â€œCÃ¡c anh em, dÃ¢u rá»ƒâ€
HTML vÃ­ dá»¥
<tr>
  <td><b>CÃ¡c anh em, dÃ¢u rá»ƒ: </b> KhÃ´ng cÃ³ anh em</td>
</tr>


Hoáº·c:

<tr>
  <td><b>CÃ¡c anh em, dÃ¢u rá»ƒ: </b><br />
      Cao VÄƒn A<br />
      Cao VÄƒn B
  </td>
</tr>

Thuáº­t toÃ¡n
if "CÃ¡c anh em" in row_text:
    data = extract_text_after_colon(row_text)

    if "KhÃ´ng cÃ³" in data:
        output["siblings"] = []
    else:
        names = split_by_br_or_newline(row)
        for name in names:
            sibling = parse_stub_member(name)
            output["siblings"].append(sibling)

parse_stub_member(name)
def parse_stub_member(name):
    gender = extract_gender_if_exists(name)
    clean_name = remove_gender(name)
    parts = clean_name.split()

    return {
        "lastName": parts[0],
        "firstName": " ".join(parts[1:]),
        "gender": gender,
        "code": None
    }


ğŸ“Œ LÆ°u Ã½

â€œdÃ¢u rá»ƒâ€ â†’ cÃ³ thá»ƒ khÃ´ng cÃ¹ng há»

Náº¿u phÃ¡t hiá»‡n tá»« khÃ³a:

"vá»£", "chá»“ng", "dÃ¢u", "rá»ƒ"
â†’ Ä‘Ã¡nh dáº¥u relationship sau, khÃ´ng gÃ¡n lÃ m sibling ruá»™t

4. TrÃ­ch xuáº¥t â€œCon cÃ¡iâ€
HTML vÃ­ dá»¥
<tr>
  <td>
    <b>Con cÃ¡i: </b><br />
       Cao Táº¿<br />
       Cao Thá»‹ NhÃ¬nh
  </td>
</tr>

Thuáº­t toÃ¡n
if "Con cÃ¡i" in row_text:
    raw_block = get_td_inner_text(row)
    children_names = extract_lines_after_colon(raw_block)

    for name in children_names:
        child = parse_stub_member(name)
        output["children"].append(child)

5. Mapping sang schema gá»‘c (ráº¥t quan trá»ng)
â“ VÃ¬ schema hiá»‡n táº¡i KHÃ”NG cÃ³ children

ğŸ‘‰ KhÃ´ng gÃ¡n children vÃ o output chÃ­nh
ğŸ‘‰ DÃ¹ng children Ä‘á»ƒ:

Táº¡o member má»›i á»Ÿ bÆ°á»›c sau

GÃ¡n:

child.father = current_member


Hoáº·c build family graph

6. TrÃ¡nh lá»—i thÆ°á»ng gáº·p

âŒ Gá»™p â€œanh emâ€ + â€œcon cÃ¡iâ€
âŒ Láº¥y cáº£ text <b> vÃ o tÃªn
âŒ KhÃ´ng strip &nbsp;
âŒ Nháº§m dÃ¢u/rá»ƒ lÃ  anh em ruá»™t

7. Checklist cho Gemini CLI

â˜‘ PhÃ¡t hiá»‡n Ä‘Ãºng block
â˜‘ TÃ¡ch tÃªn báº±ng <br>
â˜‘ KhÃ´ng táº¡o member rá»—ng
â˜‘ Children â‰  siblings
â˜‘ KhÃ´ng phÃ¡ schema gá»‘c
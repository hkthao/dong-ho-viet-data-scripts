# 1. M·ª•c ti√™u

Gemini CLI c·∫ßn th·ª±c hi·ªán:

üëâ Nh·∫≠n **HTML gia ph·∫£ (raw)**
üëâ D√πng **Python + BeautifulSoup** ƒë·ªÉ parse
üëâ Tr√≠ch xu·∫•t d·ªØ li·ªáu **theo text label ti·∫øng Vi·ªát**
üëâ Xu·∫•t ra **JSON ƒë√∫ng schema**

---

# 2. Y√™u c·∫ßu k·ªπ thu·∫≠t

* Python ‚â• 3.9
* Th∆∞ vi·ªán:

```bash
pip install beautifulsoup4 lxml
```

---

# 3. Nguy√™n t·∫Øc b·∫Øt bu·ªôc (Gemini ph·∫£i tu√¢n theo)

1. ‚ùå **KH√îNG d·ª±a v√†o class / id HTML**
2. ‚úÖ **CH·ªà d·ª±a v√†o n·ªôi dung text ti·∫øng Vi·ªát**
3. ‚úÖ **Duy·ªát `<tr>` theo th·ª© t·ª± xu·∫•t hi·ªán**
4. ‚úÖ **D√πng state machine (section-based parsing)**
5. ‚úÖ **Output lu√¥n ƒë√∫ng schema, ƒë·ªß field (k·ªÉ c·∫£ null / empty)**

---

# 4. Schema output chu·∫©n (b·∫Øt bu·ªôc)

```python
OUTPUT_SCHEMA = {
    "lastName": "",
    "firstName": "",
    "code": "",
    "nickname": "",
    "dateOfBirth": None,
    "dateOfDeath": None,
    "dateOfDeathLunar": None,
    "placeOfBirth": None,
    "placeOfDeath": None,
    "phone": "",
    "email": "",
    "address": "",
    "gender": "",
    "avatarUrl": "",
    "avatarBase64": "",
    "occupation": "",
    "biography": "",
    "isRoot": False,
    "isDeceased": False,
    "order": 0,
    "generation": 0,
    "father": None,
    "mother": None,
    "spouses": []
}
```

---

# 5. Chi·∫øn l∆∞·ª£c x·ª≠ l√Ω HTML

## 5.1 Parse DOM

```python
soup = BeautifulSoup(html, "lxml")
rows = soup.find_all("tr")
```

---

## 5.2 Khai b√°o state (r·∫•t quan tr·ªçng)

```python
current_section = None
current_spouse = None
```

Section c√≥ th·ªÉ l√†:

```python
FAMILY
PERSON
SPOUSE
CHILDREN
```

---

# 6. Nh·∫≠n di·ªán section b·∫±ng TEXT

Gemini CLI ph·∫£i d√≤ **text trong `<tr>`**

```python
row_text = row.get_text(strip=True)
```

| Text ch·ª©a             | Section  |
| --------------------- | -------- |
| Chi ti·∫øt gia ƒë√¨nh     | FAMILY   |
| Ng∆∞·ªùi trong gia ƒë√¨nh  | PERSON   |
| Li√™n quan (ch·ªìng, v·ª£) | SPOUSE   |
| Con c√°i               | CHILDREN |

---

# 7. Mapping chi ti·∫øt t·ª´ng field

## 7.1 H·ªç ‚Äì t√™n ‚Äì gi·ªõi t√≠nh

HTML:

```
T√™n | Cao Tri·∫øt (Nam)
```

### Quy t·∫Øc:

* Text trong `()` ‚Üí gender
* Ph·∫ßn c√≤n l·∫°i ‚Üí full name
* T·ª´ ƒë·∫ßu ti√™n ‚Üí lastName
* Ph·∫ßn c√≤n l·∫°i ‚Üí firstName

```python
def parse_name_gender(text):
    gender = extract_between_parentheses(text)
    name = remove_parentheses(text)
    parts = name.split()
    return {
        "lastName": parts[0],
        "firstName": " ".join(parts[1:]),
        "gender": gender
    }
```

---

## 7.2 Nickname

```
T√™n th∆∞·ªùng | L√Ω Tri·∫øt
```

```python
output["nickname"] = value
```

---

## 7.3 Generation (ƒê·ªùi th·ª©)

```
ƒê·ªùi th·ª©: 0
```

```python
output["generation"] = int(value)
```

---

## 7.4 Order (L√† con th·ª©)

```python
output["order"] = int(value)
```

---

## 7.5 Ng√†y sinh / ng√†y m·∫•t

```python
if label == "Ng√†y sinh":
    output["dateOfBirth"] = normalize_date(value)

if label == "Ng√†y m·∫•t":
    output["dateOfDeath"] = normalize_date(value)
    output["isDeceased"] = True
```

---

## 7.6 H∆∞·ªüng th·ªç ‚Üí isDeceased

```python
if label == "H∆∞·ªüng th·ªç":
    output["isDeceased"] = True
```

---

## 7.7 N∆°i an t√°ng ‚Üí placeOfDeath

```python
if label == "N∆°i an t√°ng":
    output["placeOfDeath"] = value
```

---

## 7.8 Biography (ghi ch√∫ d√†i)

Pattern:

```
S·ª± nghi·ªáp, c√¥ng ƒë·ª©c, ghi ch√∫
<tr><td>TEXT D√ÄI</td></tr>
```

```python
if label == "S·ª± nghi·ªáp, c√¥ng ƒë·ª©c, ghi ch√∫":
    next_row = rows[i + 1]
    output["biography"] = clean_text(next_row.get_text())
```

---

## 7.9 Father

HTML:

```
L√† con c·ªßa: Thu·ª∑ t·ªï
```

```python
output["father"] = {
    "lastName": extract_last_name(value),
    "firstName": extract_first_name(value),
    "code": None,
    "gender": "Nam"
}
```

```python
output["isRoot"] = False
```

N·∫øu kh√¥ng c√≥ d√≤ng n√†y:

```python
output["isRoot"] = True
```

---

## 7.10 Spouses (v·ª£ / ch·ªìng)

### Khi g·∫∑p:

```
Li√™n quan (ch·ªìng, v·ª£)
```

T·∫°o object spouse m·ªõi khi g·∫∑p `"T√™n"`

```python
current_spouse = {
    "lastName": "",
    "firstName": "",
    "gender": "",
    "dateOfBirth": None,
    "dateOfDeath": None,
    "biography": ""
}
```

Mapping gi·ªëng PERSON nh∆∞ng ƒë∆°n gi·∫£n h∆°n.

Khi g·∫∑p spouse m·ªõi ‚Üí push spouse c≈© v√†o `output["spouses"]`.

---

# 8. Chu·∫©n ho√° d·ªØ li·ªáu (b·∫Øt bu·ªôc)

Gemini CLI ph·∫£i:

* Trim string
* `""` cho text r·ªóng
* `None` cho date kh√¥ng c√≥
* Remove `&nbsp;`, tag XML l·∫°
* Kh√¥ng b·ªè field n√†o trong schema

---

# 9. Sinh code (n·∫øu c·∫ßn)

```python
output["code"] = generate_member_code(
    lastName=output["lastName"],
    gender=output["gender"],
    generation=output["generation"],
    order=output["order"]
)
```

---

# 10. Output cu·ªëi c√πng

```python
return json.dumps(output, ensure_ascii=False, indent=2)
```

---

# 11. Checklist ƒë·ªÉ Gemini CLI t·ª± ki·ªÉm tra

‚òë C√≥ ƒë·ªß field schema
‚òë Kh√¥ng crash n·∫øu thi·∫øu d·ªØ li·ªáu
‚òë Ch·∫°y ƒë∆∞·ª£c v·ªõi nhi·ªÅu page c√πng format
‚òë Kh√¥ng hardcode index HTML

---